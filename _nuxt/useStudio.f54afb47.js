import{a as ee,a5 as Z,S as j,l as b,K as te,_ as ne,a7 as ie,o as $,f as A,h as oe,M as ae,j as v,v as N,q as z,w as H,T as V,t as se,p as re,i as le,k as ce,a0 as de,I as K,J as O,ag as ue,ao as U,m as G,ap as W,aq as pe,ar as fe,ah as F}from"./entry.d682b40b.js";import{r as ve}from"./asyncData.3b6ecb1f.js";/* empty css                               */const T=l=>(re("data-v-30b585b5"),l=l(),le(),l),we=T(()=>v("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[v("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),he=T(()=>v("span",null,"Preview mode enabled",-1)),ye={key:0},me=T(()=>v("div",{id:"__preview_background"},null,-1)),_e=T(()=>v("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[v("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),ge=T(()=>v("p",null,"Initializing the preview...",-1)),ke={key:0},Pe=T(()=>v("div",{id:"__preview_background"},null,-1)),Ce={id:"__preview_loader"},xe=ee({__name:"ContentPreviewMode",props:{previewToken:{type:Object,required:!0},apiURL:{type:String,required:!0},exitPreviewMode:{type:Function,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(l){const o=l,a=["__nuxt_preview","__preview_enabled"],d=Z(),u=j(),f=b(!0),_=b(!1),e=b(!1),c=b("");let s;const w=()=>o.exitPreviewMode(),k=async C=>{const h=await o.syncPreview(C);if(e.value!==!0){if(!h){setTimeout(()=>k(C),1e3);return}e.value=!0,d.callHook("nuxt-studio:preview:ready"),u.replace({query:{}}),window.parent&&window.self!==window.parent&&s.disconnect()}};return te(async()=>{s=(await ne(()=>import("./index.9fea434a.js"),[],import.meta.url)).connect(`${o.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:o.previewToken.value}});let h;s.on("connect",()=>{h=setTimeout(()=>{e.value||(h=setTimeout(()=>{c.value="Preview sync timed out",e.value=!1},3e4),s.emit("draft:requestSync"))},3e4)});const x=()=>{h&&(clearTimeout(h),h=null)};s.on("draft:sync",async I=>{if(x(),!I){try{s.once("draft:ready",()=>{s.emit("draft:requestSync")}),await o.requestPreviewSyncAPI()}catch(R){switch(x(),R.response.status){case 404:c.value="Preview draft not found",e.value=!1;break;default:c.value="An error occurred while syncing preview",e.value=!1}}return}k(I)}),s.on("draft:unauthorized",()=>{x(),c.value="Unauthorized preview token",e.value=!1}),s.on("disconnect",()=>{x()}),document.body.classList.add(...a),s.on("draft:update",I=>{_.value=!0,o.syncPreview(I),_.value=!1})}),ie(()=>{document.body.classList.remove(...a)}),(C,h)=>($(),A("div",null,[f.value?($(),A("div",{key:0,id:"__nuxt_preview",class:oe({__preview_ready:e.value,__preview_refreshing:_.value})},[e.value?($(),A(ae,{key:0},[we,he,v("button",{onClick:w}," Close ")],64)):N("",!0)],2)):N("",!0),z(V,{name:"preview-loading"},{default:H(()=>[f.value&&!e.value&&!c.value?($(),A("div",ye,[me,v("div",{id:"__preview_loader"},[_e,ge,v("button",{onClick:w}," Cancel ")])])):N("",!0)]),_:1}),z(V,{name:"preview-loading"},{default:H(()=>[c.value?($(),A("div",ke,[Pe,v("div",Ce,[v("p",null,se(c.value),1),v("button",{onClick:w}," Exit preview ")])])):N("",!0)]),_:1})]))}}),Ie=ce(xe,[["__scopeId","data-v-30b585b5"]]),Se=(l=[],o,a)=>{const d=[...o||[]],u=[...a||[]],f=JSON.parse(JSON.stringify(l));for(const e of d)if(e.oldPath)if(u.splice(u.findIndex(s=>s.path===e.oldPath),1),d.find(s=>s.path===e.oldPath))f.push({path:e.path,parsed:e.parsed});else{const s=f.find(w=>w.path===e.oldPath);s&&(s.path=e.path,e.parsed?s.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(w=>{s.parsed[w]=e.pathMeta[w]}))}else if(e.new)f.push({path:e.path,parsed:e.parsed});else{const c=f.find(s=>s.path===e.path);c&&Object.assign(c,{path:e.path,parsed:e.parsed})}for(const e of u)f.splice(f.findIndex(c=>c.path===e.path),1);const _=new Intl.Collator(void 0,{numeric:!0});return f.sort((e,c)=>_.compare(e.path,c.path)),f},J=".studio",S={appConfig:`${J}/app.config.json`,tokensConfig:`${J}/tokens.config.json`},be=l=>{let o;return(...a)=>(o||(o=l()),o)};function Q(l,o){for(const a in l){const d=o[a];a in o||delete l[a],d!==null&&typeof d=="object"&&Q(l[a],o[a])}}function X(l,o){for(const a in o){const d=o[a];d!==null&&typeof d=="object"?(l[a]=l[a]||{},X(l[a],d)):l[a]=d}}const Te=be(()=>JSON.parse(JSON.stringify(G()))),Le=l=>{const o=Z(),{studio:a,content:d}=de().public;K();const u=O("studio-preview-token",()=>l);window.localStorage.setItem("previewToken",u.value);const f=Te();let _;const e=O("studio-client-db",()=>null),c=O("studio-preview-db-files",()=>[]);e.value||(o.hook("content:storage",t=>{e.value=t}),ue("/non-existing-path").findOne());const s=async(t,n,y=!0)=>{const p=await t.getKeys(`${u.value}:`);await Promise.all(p.map(r=>t.removeItem(r)));const i=new Set(n.map(r=>r.parsed._id.split(":").shift()));await t.setItem(`${u.value}$`,JSON.stringify({ignoreSources:Array.from(i)})),await Promise.all(n.map(r=>t.setItem(`${u.value}:${r.parsed._id}`,JSON.stringify(r.parsed))))},w=t=>{const n=U(o,G);X(n,W(t,f)),t||Q(n,f)},k=t=>{var y,p,i,r;const n=(r=(i=(p=(y=o==null?void 0:o.vueApp)==null?void 0:y._context)==null?void 0:p.config)==null?void 0:i.globalProperties)==null?void 0:r.$pinceauTheme;!n||!(n!=null&&n.updateTheme)||(_||(_=JSON.parse(JSON.stringify((n==null?void 0:n.theme.value)||{}))),U(o,n.updateTheme,[W(t,_)]))},C=async t=>{if(c.value=t.files=t.files||c.value||[],!e.value)return!1;const n=Se(t.files,t.additions,t.deletions),y=n.filter(r=>!r.path.startsWith(J));await s(e.value,y,(t.files||[]).length!==0);const p=n.find(r=>r.path===S.appConfig);w(p==null?void 0:p.parsed);const i=n.find(r=>r.path===S.tokensConfig);return k(i==null?void 0:i.parsed),E(),!0},h=async()=>{await $fetch("api/projects/preview/sync",{baseURL:a==null?void 0:a.apiURL,method:"POST",params:{token:u.value}})},x=()=>{window.localStorage.removeItem("previewToken"),K().query.preview="",window.location.reload()},I=()=>{const t=document.createElement("div");t.id="__nuxt_preview_wrapper",document.body.appendChild(t),pe(Ie,{previewToken:u,apiURL:a==null?void 0:a.apiURL,syncPreview:C,requestPreviewSyncAPI:h,exitPreviewMode:x}).mount(t)},R=async t=>{var y,p,i;if(!t)return null;t=t.replace(/\/$/,"");let n=await((y=e.value)==null?void 0:y.getItem(`${u.value}:${t}`));return n||(n=await((p=e.value)==null?void 0:p.getItem(`cached:${t}`))),n||(n=n=await((i=e.value)==null?void 0:i.getItem(t))),n},D=t=>{var n;e.value&&e.value.setItem(`${u.value}:${(n=t.parsed)==null?void 0:n._id}`,JSON.stringify(t.parsed))},B=async t=>{var n;await((n=e.value)==null?void 0:n.removeItem(`${u.value}:${t}`))},E=async()=>{if(d!=null&&d.documentDriven){const{pages:t}=U(o,fe);for(const n in t.value)t.value[n]&&(t.value[n]=await R(t.value[n]._id))}U(o,ve)};return{apiURL:a==null?void 0:a.apiURL,contentStorage:e,syncPreviewFiles:s,syncPreviewAppConfig:w,syncPreviewTokensConfig:k,requestPreviewSynchronization:h,findContentWithId:R,updateContent:D,removeContentWithId:B,requestRerender:E,mountPreviewUI:I,initiateIframeCommunication:Y};function Y(){if(!window.parent||window.self===window.parent)return;const t=j(),n=b(""),y=b(!0),p=i=>({path:i.path,query:F(i.query),params:F(i.params),fullPath:i.fullPath,meta:F(i.meta)});window.addEventListener("keydown",i=>{(i.metaKey||i.ctrlKey||i.altKey||i.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:i.key,metaKey:i.metaKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,altKey:i.altKey}},"*")}),window.addEventListener("message",async i=>{const{type:r,payload:q={}}=i.data||{};switch(r){case"nuxt-studio:editor:file-selected":{const m=await R(q.path);m&&(m._partial||m._path!==K().path&&(n.value=m._path,t.push(m._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:m=[],deletions:M=[]}=q;for(const g of m)await D(g);for(const g of M)await B(g.path);E();break}case"nuxt-studio:config:file-changed":{const{additions:m=[],deletions:M=[]}=q,g=m.find(P=>P.path===S.appConfig);g&&w(g==null?void 0:g.parsed),M.find(P=>P.path===S.appConfig)&&w(void 0);const L=m.find(P=>P.path===S.tokensConfig);L&&k(L==null?void 0:L.parsed),M.find(P=>P.path===S.tokensConfig)&&k(void 0);break}}}),o.hook("content:document-driven:finish",({route:i,page:r,dedup:q})=>{if(q||y.value){y.value=!1;return}if(r&&n.value===r._path){n.value="";return}window.parent.postMessage({type:"nuxt-studio:preview:document-driven:finish",payload:{...p(i),contentId:r==null?void 0:r._id}},"*")}),o.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:p(K())},"*"),t==null||t.afterEach(i=>{window.parent.postMessage({type:"nuxt-studio:preview:route-changed",payload:p(i)},"*")})})}};export{Le as useStudio};
