import{a as ne,a5 as G,S as Q,l as T,K as oe,_ as ie,a7 as ae,o as b,f as R,h as se,M as re,j as f,v as L,q as W,w as V,T as Z,t as ce,p as le,i as de,k as ue,a0 as pe,I as N,J as O,ag as ve,ao as J,ap as K,m as X,aq as j,ar as fe,as as we,ah as D}from"./entry.9f6108f7.js";import{r as he}from"./asyncData.24fa953d.js";/* empty css                               */const q=l=>(le("data-v-7214a338"),l=l(),de(),l),me=q(()=>f("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[f("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),ye=q(()=>f("span",null,"Preview mode enabled",-1)),_e={key:0},ge=q(()=>f("div",{id:"__preview_background"},null,-1)),ke=q(()=>f("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[f("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),Pe=q(()=>f("p",null,"Initializing the preview...",-1)),Ce={key:0},Se=q(()=>f("div",{id:"__preview_background"},null,-1)),xe={id:"__preview_loader"},Ie=ne({__name:"ContentPreviewMode",props:{previewToken:{type:Object,required:!0},apiURL:{type:String,required:!0},exitPreviewMode:{type:Function,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(l){const i=l,a=["__nuxt_preview","__preview_enabled"],d=G(),u=Q(),p=T(!0),g=T(!1),n=T(!1),s=T("");let r;const h=()=>i.exitPreviewMode(),P=async _=>{const m=await i.syncPreview(_);if(n.value!==!0){if(!m){setTimeout(()=>P(_),1e3);return}n.value=!0,d.callHook("nuxt-studio:preview:ready"),u.replace({query:{}}),window.parent&&window.self!==window.parent&&r.disconnect()}};return oe(async()=>{r=(await ie(()=>import("./index.9fea434a.js"),[],import.meta.url)).connect(`${i.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:i.previewToken.value}});let m;r.on("connect",()=>{m=setTimeout(()=>{n.value||(m=setTimeout(()=>{s.value="Preview sync timed out",n.value=!1},3e4),r.emit("draft:requestSync"))},3e4)});const C=()=>{m&&(clearTimeout(m),m=null)};r.on("draft:sync",async x=>{if(C(),!x){try{r.once("draft:ready",()=>{r.emit("draft:requestSync")}),await i.requestPreviewSyncAPI()}catch(E){switch(C(),E.response.status){case 404:s.value="Preview draft not found",n.value=!1;break;default:s.value="An error occurred while syncing preview",n.value=!1}}return}P(x)}),r.on("draft:unauthorized",()=>{C(),s.value="Unauthorized preview token",n.value=!1}),r.on("disconnect",()=>{C()}),document.body.classList.add(...a),r.on("draft:update",x=>{g.value=!0,i.syncPreview(x),g.value=!1})}),ae(()=>{document.body.classList.remove(...a)}),(_,m)=>(b(),R("div",null,[p.value?(b(),R("div",{key:0,id:"__nuxt_preview",class:se({__preview_ready:n.value,__preview_refreshing:g.value})},[n.value?(b(),R(re,{key:0},[me,ye,f("button",{onClick:h}," Close ")],64)):L("",!0)],2)):L("",!0),W(Z,{name:"preview-loading"},{default:V(()=>[p.value&&!n.value&&!s.value?(b(),R("div",_e,[ge,f("div",{id:"__preview_loader"},[ke,Pe,f("button",{onClick:h}," Cancel ")])])):L("",!0)]),_:1}),W(Z,{name:"preview-loading"},{default:V(()=>[s.value?(b(),R("div",Ce,[Se,f("div",xe,[f("p",null,ce(s.value),1),f("button",{onClick:h}," Exit preview ")])])):L("",!0)]),_:1})]))}}),Te=ue(Ie,[["__scopeId","data-v-7214a338"]]),qe=(l=[],i,a)=>{const d=[...i||[]],u=[...a||[]],p=JSON.parse(JSON.stringify(l));for(const n of d)if(n.oldPath)if(u.splice(u.findIndex(r=>r.path===n.oldPath),1),d.find(r=>r.path===n.oldPath))p.push({path:n.path,parsed:n.parsed});else{const r=p.find(h=>h.path===n.oldPath);r&&(r.path=n.path,n.parsed?r.parsed=n.parsed:n.pathMeta&&["_file","_path","_id","_locale"].forEach(h=>{r.parsed[h]=n.pathMeta[h]}))}else if(n.new)p.push({path:n.path,parsed:n.parsed});else{const s=p.find(r=>r.path===n.path);s&&Object.assign(s,{path:n.path,parsed:n.parsed})}for(const n of u)p.splice(p.findIndex(s=>s.path===n.path),1);const g=new Intl.Collator(void 0,{numeric:!0});return p.sort((n,s)=>g.compare(n.path,s.path)),p},B=".studio",I={appConfig:`${B}/app.config.json`,tokensConfig:`${B}/tokens.config.json`},Ae=l=>{let i;return(...a)=>(i||(i=l()),i)};function Y(l,i){for(const a in l){const d=i[a];a in i||delete l[a],d!==null&&typeof d=="object"&&Y(l[a],i[a])}}function ee(l,i){for(const a in i){const d=i[a];d!==null&&typeof d=="object"?(l[a]=l[a]||{},ee(l[a],d)):l[a]=d}}const be=Ae(()=>JSON.parse(JSON.stringify(X()))),Ke=l=>{const i=G(),{studio:a,content:d}=pe().public;N();const u=O("studio-preview-token",()=>l),p=()=>{const e=J("previewToken",{sameSite:"none",secure:!0});e.value=u.value,window.localStorage.setItem("previewToken",u.value),console.log("after",J("previewToken",{sameSite:"none",secure:!0}).value)};document.hasStorageAccess==null?p():document.hasStorageAccess().then(e=>{var t;e?p():(t=document.querySelector('[aria-label="Color Mode"]'))==null||t.addEventListener("click",()=>{document.requestStorageAccess().then(()=>{p()}).catch(w=>{console.error("Error obtaining storage access",w)})})});const g=be();let n;const s=O("studio-client-db",()=>null),r=O("studio-preview-db-files",()=>[]);s.value||(i.hook("content:storage",e=>{s.value=e}),ve("/non-existing-path").findOne());const h=async(e,t,w=!0)=>{const v=await e.getKeys(`${u.value}:`);await Promise.all(v.map(c=>e.removeItem(c)));const o=new Set(t.map(c=>c.parsed._id.split(":").shift()));await e.setItem(`${u.value}$`,JSON.stringify({ignoreSources:Array.from(o)})),await Promise.all(t.map(c=>e.setItem(`${u.value}:${c.parsed._id}`,JSON.stringify(c.parsed))))},P=e=>{const t=K(i,X);ee(t,j(e,g)),e||Y(t,g)},_=e=>{var w,v,o,c;const t=(c=(o=(v=(w=i==null?void 0:i.vueApp)==null?void 0:w._context)==null?void 0:v.config)==null?void 0:o.globalProperties)==null?void 0:c.$pinceauTheme;!t||!(t!=null&&t.updateTheme)||(n||(n=JSON.parse(JSON.stringify((t==null?void 0:t.theme.value)||{}))),K(i,t.updateTheme,[j(e,n)]))},m=async e=>{if(r.value=e.files=e.files||r.value||[],!s.value)return!1;const t=qe(e.files,e.additions,e.deletions),w=t.filter(c=>!c.path.startsWith(B));await h(s.value,w,(e.files||[]).length!==0);const v=t.find(c=>c.path===I.appConfig);P(v==null?void 0:v.parsed);const o=t.find(c=>c.path===I.tokensConfig);return _(o==null?void 0:o.parsed),F(),!0},C=async()=>{await $fetch("api/projects/preview/sync",{baseURL:a==null?void 0:a.apiURL,method:"POST",params:{token:u.value}})},x=()=>{J("previewToken").value="",previewCookie.value="",window.localStorage.removeItem("previewToken"),N().query.preview="",window.location.reload()},E=()=>{const e=document.createElement("div");e.id="__nuxt_preview_wrapper",document.body.appendChild(e),fe(Te,{previewToken:u,apiURL:a==null?void 0:a.apiURL,syncPreview:m,requestPreviewSyncAPI:C,exitPreviewMode:x}).mount(e)},U=async e=>{var w,v,o;if(!e)return null;e=e.replace(/\/$/,"");let t=await((w=s.value)==null?void 0:w.getItem(`${u.value}:${e}`));return t||(t=await((v=s.value)==null?void 0:v.getItem(`cached:${e}`))),t||(t=t=await((o=s.value)==null?void 0:o.getItem(e))),t},z=e=>{var t;s.value&&s.value.setItem(`${u.value}:${(t=e.parsed)==null?void 0:t._id}`,JSON.stringify(e.parsed))},H=async e=>{var t;await((t=s.value)==null?void 0:t.removeItem(`${u.value}:${e}`))},F=async()=>{if(d!=null&&d.documentDriven){const{pages:e}=K(i,we);for(const t in e.value)e.value[t]&&(e.value[t]=await U(e.value[t]._id))}K(i,he)};return{apiURL:a==null?void 0:a.apiURL,contentStorage:s,syncPreviewFiles:h,syncPreviewAppConfig:P,syncPreviewTokensConfig:_,requestPreviewSynchronization:C,findContentWithId:U,updateContent:z,removeContentWithId:H,requestRerender:F,mountPreviewUI:E,initiateIframeCommunication:te};function te(){if(!window.parent||window.self===window.parent)return;const e=Q(),t=T(""),w=T(!0),v=o=>({path:o.path,query:D(o.query),params:D(o.params),fullPath:o.fullPath,meta:D(o.meta)});window.addEventListener("keydown",o=>{(o.metaKey||o.ctrlKey||o.altKey||o.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:o.key,metaKey:o.metaKey,ctrlKey:o.ctrlKey,shiftKey:o.shiftKey,altKey:o.altKey}},"*")}),window.addEventListener("message",async o=>{const{type:c,payload:A={}}=o.data||{};switch(c){case"nuxt-studio:editor:file-selected":{const y=await U(A.path);y&&(y._partial||y._path!==N().path&&(t.value=y._path,e.push(y._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:y=[],deletions:M=[]}=A;for(const k of y)await z(k);for(const k of M)await H(k.path);F();break}case"nuxt-studio:config:file-changed":{const{additions:y=[],deletions:M=[]}=A,k=y.find(S=>S.path===I.appConfig);k&&P(k==null?void 0:k.parsed),M.find(S=>S.path===I.appConfig)&&P(void 0);const $=y.find(S=>S.path===I.tokensConfig);$&&_($==null?void 0:$.parsed),M.find(S=>S.path===I.tokensConfig)&&_(void 0);break}}}),i.hook("content:document-driven:finish",({route:o,page:c,dedup:A})=>{if(A||w.value){w.value=!1;return}if(c&&t.value===c._path){t.value="";return}window.parent.postMessage({type:"nuxt-studio:preview:document-driven:finish",payload:{...v(o),contentId:c==null?void 0:c._id}},"*")}),i.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:v(N())},"*"),e==null||e.afterEach(o=>{window.parent.postMessage({type:"nuxt-studio:preview:route-changed",payload:v(o)},"*")})})}};export{Ke as useStudio};
