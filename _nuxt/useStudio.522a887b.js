import{a as oe,a5 as G,S as Q,l as T,K as ne,_ as ie,a7 as ae,o as A,f as b,h as se,M as re,j as f,v as N,q as V,w as W,T as j,t as le,p as ce,i as de,k as ue,a0 as pe,I as K,J,ao as $,ag as ve,ap as U,m as X,aq as Z,ar as fe,as as we,ah as D}from"./entry.2125a8dc.js";import{r as he}from"./asyncData.4ef57cb5.js";/* empty css                               */const q=c=>(ce("data-v-c2a124a4"),c=c(),de(),c),me=q(()=>f("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[f("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),ye=q(()=>f("span",null,"Preview mode enabled",-1)),_e={key:0},ge=q(()=>f("div",{id:"__preview_background"},null,-1)),ke=q(()=>f("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[f("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),Ce=q(()=>f("p",null,"Initializing the preview...",-1)),Pe={key:0},Se=q(()=>f("div",{id:"__preview_background"},null,-1)),xe={id:"__preview_loader"},Ie=oe({__name:"ContentPreviewMode",props:{previewToken:{type:Object,required:!0},apiURL:{type:String,required:!0},exitPreviewMode:{type:Function,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(c){const i=c,a=["__nuxt_preview","__preview_enabled"],u=G(),d=Q(),p=T(!0),g=T(!1),o=T(!1),s=T("");let r;const w=()=>i.exitPreviewMode(),C=async _=>{const m=await i.syncPreview(_);if(o.value!==!0){if(!m){setTimeout(()=>C(_),1e3);return}o.value=!0,u.callHook("nuxt-studio:preview:ready"),d.replace({query:{}}),window.parent&&window.self!==window.parent&&r.disconnect()}};return ne(async()=>{r=(await ie(()=>import("./index.9fea434a.js"),[],import.meta.url)).connect(`${i.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:i.previewToken.value}});let m;r.on("connect",()=>{m=setTimeout(()=>{o.value||(m=setTimeout(()=>{s.value="Preview sync timed out",o.value=!1},3e4),r.emit("draft:requestSync"))},3e4)});const P=()=>{m&&(clearTimeout(m),m=null)};r.on("draft:sync",async x=>{if(P(),!x){try{r.once("draft:ready",()=>{r.emit("draft:requestSync")}),await i.requestPreviewSyncAPI()}catch(E){switch(P(),E.response.status){case 404:s.value="Preview draft not found",o.value=!1;break;default:s.value="An error occurred while syncing preview",o.value=!1}}return}C(x)}),r.on("draft:unauthorized",()=>{P(),s.value="Unauthorized preview token",o.value=!1}),r.on("disconnect",()=>{P()}),document.body.classList.add(...a),r.on("draft:update",x=>{g.value=!0,i.syncPreview(x),g.value=!1})}),ae(()=>{document.body.classList.remove(...a)}),(_,m)=>(A(),b("div",null,[p.value?(A(),b("div",{key:0,id:"__nuxt_preview",class:se({__preview_ready:o.value,__preview_refreshing:g.value})},[o.value?(A(),b(re,{key:0},[me,ye,f("button",{onClick:w}," Close ")],64)):N("",!0)],2)):N("",!0),V(j,{name:"preview-loading"},{default:W(()=>[p.value&&!o.value&&!s.value?(A(),b("div",_e,[ge,f("div",{id:"__preview_loader"},[ke,Ce,f("button",{onClick:w}," Cancel ")])])):N("",!0)]),_:1}),V(j,{name:"preview-loading"},{default:W(()=>[s.value?(A(),b("div",Pe,[Se,f("div",xe,[f("p",null,le(s.value),1),f("button",{onClick:w}," Exit preview ")])])):N("",!0)]),_:1})]))}}),Te=ue(Ie,[["__scopeId","data-v-c2a124a4"]]),qe=(c=[],i,a)=>{const u=[...i||[]],d=[...a||[]],p=JSON.parse(JSON.stringify(c));for(const o of u)if(o.oldPath)if(d.splice(d.findIndex(r=>r.path===o.oldPath),1),u.find(r=>r.path===o.oldPath))p.push({path:o.path,parsed:o.parsed});else{const r=p.find(w=>w.path===o.oldPath);r&&(r.path=o.path,o.parsed?r.parsed=o.parsed:o.pathMeta&&["_file","_path","_id","_locale"].forEach(w=>{r.parsed[w]=o.pathMeta[w]}))}else if(o.new)p.push({path:o.path,parsed:o.parsed});else{const s=p.find(r=>r.path===o.path);s&&Object.assign(s,{path:o.path,parsed:o.parsed})}for(const o of d)p.splice(p.findIndex(s=>s.path===o.path),1);const g=new Intl.Collator(void 0,{numeric:!0});return p.sort((o,s)=>g.compare(o.path,s.path)),p},B=".studio",I={appConfig:`${B}/app.config.json`,tokensConfig:`${B}/tokens.config.json`},Re=c=>{let i;return(...a)=>(i||(i=c()),i)};function Y(c,i){for(const a in c){const u=i[a];a in i||delete c[a],u!==null&&typeof u=="object"&&Y(c[a],i[a])}}function ee(c,i){for(const a in i){const u=i[a];u!==null&&typeof u=="object"?(c[a]=c[a]||{},ee(c[a],u)):c[a]=u}}const Ae=Re(()=>JSON.parse(JSON.stringify(X()))),Ke=c=>{const i=G(),{studio:a,content:u}=pe().public;K();const d=J("studio-preview-token",()=>c);document.requestStorageAccess().then(()=>{console.log("resolved")}).catch(()=>{console.log("rejected")});const p=$("previewToken",{sameSite:"none",secure:!0});console.log("previewCookie",p.value),p.value=d.value,window.localStorage.setItem("previewToken",d.value),console.log("previewCookie after",$("previewToken",{sameSite:"none",secure:!0}).value),console.log(window.document.cookie),window.onclick=()=>{document.requestStorageAccess().then(()=>{console.log("resolved")}).catch(()=>{console.log("rejected")});const e=$("previewToken",{sameSite:"none",secure:!0});console.log("previewCookie",e.value),e.value=d.value,window.localStorage.setItem("previewToken",d.value),console.log("previewCookie after",$("previewToken",{sameSite:"none",secure:!0}).value),console.log(window.document.cookie)};const g=Ae();let o;const s=J("studio-client-db",()=>null),r=J("studio-preview-db-files",()=>[]);s.value||(i.hook("content:storage",e=>{s.value=e}),ve("/non-existing-path").findOne());const w=async(e,t,h=!0)=>{const v=await e.getKeys(`${d.value}:`);await Promise.all(v.map(l=>e.removeItem(l)));const n=new Set(t.map(l=>l.parsed._id.split(":").shift()));await e.setItem(`${d.value}$`,JSON.stringify({ignoreSources:Array.from(n)})),await Promise.all(t.map(l=>e.setItem(`${d.value}:${l.parsed._id}`,JSON.stringify(l.parsed))))},C=e=>{const t=U(i,X);ee(t,Z(e,g)),e||Y(t,g)},_=e=>{var h,v,n,l;const t=(l=(n=(v=(h=i==null?void 0:i.vueApp)==null?void 0:h._context)==null?void 0:v.config)==null?void 0:n.globalProperties)==null?void 0:l.$pinceauTheme;!t||!(t!=null&&t.updateTheme)||(o||(o=JSON.parse(JSON.stringify((t==null?void 0:t.theme.value)||{}))),U(i,t.updateTheme,[Z(e,o)]))},m=async e=>{if(r.value=e.files=e.files||r.value||[],!s.value)return!1;const t=qe(e.files,e.additions,e.deletions),h=t.filter(l=>!l.path.startsWith(B));await w(s.value,h,(e.files||[]).length!==0);const v=t.find(l=>l.path===I.appConfig);C(v==null?void 0:v.parsed);const n=t.find(l=>l.path===I.tokensConfig);return _(n==null?void 0:n.parsed),F(),!0},P=async()=>{await $fetch("api/projects/preview/sync",{baseURL:a==null?void 0:a.apiURL,method:"POST",params:{token:d.value}})},x=()=>{$("previewToken").value="",p.value="",window.localStorage.removeItem("previewToken"),K().query.preview="",window.location.reload()},E=()=>{const e=document.createElement("div");e.id="__nuxt_preview_wrapper",document.body.appendChild(e),fe(Te,{previewToken:d,apiURL:a==null?void 0:a.apiURL,syncPreview:m,requestPreviewSyncAPI:P,exitPreviewMode:x}).mount(e)},O=async e=>{var h,v,n;if(!e)return null;e=e.replace(/\/$/,"");let t=await((h=s.value)==null?void 0:h.getItem(`${d.value}:${e}`));return t||(t=await((v=s.value)==null?void 0:v.getItem(`cached:${e}`))),t||(t=t=await((n=s.value)==null?void 0:n.getItem(e))),t},z=e=>{var t;s.value&&s.value.setItem(`${d.value}:${(t=e.parsed)==null?void 0:t._id}`,JSON.stringify(e.parsed))},H=async e=>{var t;await((t=s.value)==null?void 0:t.removeItem(`${d.value}:${e}`))},F=async()=>{if(u!=null&&u.documentDriven){const{pages:e}=U(i,we);for(const t in e.value)e.value[t]&&(e.value[t]=await O(e.value[t]._id))}U(i,he)};return{apiURL:a==null?void 0:a.apiURL,contentStorage:s,syncPreviewFiles:w,syncPreviewAppConfig:C,syncPreviewTokensConfig:_,requestPreviewSynchronization:P,findContentWithId:O,updateContent:z,removeContentWithId:H,requestRerender:F,mountPreviewUI:E,initiateIframeCommunication:te};function te(){if(!window.parent||window.self===window.parent)return;const e=Q(),t=T(""),h=T(!0),v=n=>({path:n.path,query:D(n.query),params:D(n.params),fullPath:n.fullPath,meta:D(n.meta)});window.addEventListener("keydown",n=>{(n.metaKey||n.ctrlKey||n.altKey||n.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:n.key,metaKey:n.metaKey,ctrlKey:n.ctrlKey,shiftKey:n.shiftKey,altKey:n.altKey}},"*")}),window.addEventListener("message",async n=>{const{type:l,payload:R={}}=n.data||{};switch(l){case"nuxt-studio:editor:file-selected":{const y=await O(R.path);y&&(y._partial||y._path!==K().path&&(t.value=y._path,e.push(y._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:y=[],deletions:M=[]}=R;for(const k of y)await z(k);for(const k of M)await H(k.path);F();break}case"nuxt-studio:config:file-changed":{const{additions:y=[],deletions:M=[]}=R,k=y.find(S=>S.path===I.appConfig);k&&C(k==null?void 0:k.parsed),M.find(S=>S.path===I.appConfig)&&C(void 0);const L=y.find(S=>S.path===I.tokensConfig);L&&_(L==null?void 0:L.parsed),M.find(S=>S.path===I.tokensConfig)&&_(void 0);break}}}),i.hook("content:document-driven:finish",({route:n,page:l,dedup:R})=>{if(R||h.value){h.value=!1;return}if(l&&t.value===l._path){t.value="";return}window.parent.postMessage({type:"nuxt-studio:preview:document-driven:finish",payload:{...v(n),contentId:l==null?void 0:l._id}},"*")}),i.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:v(K())},"*"),e==null||e.afterEach(n=>{window.parent.postMessage({type:"nuxt-studio:preview:route-changed",payload:v(n)},"*")})})}};export{Ke as useStudio};
